name: Build XT-ScalperPro APK

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # üß∞ –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –≤—Å—ñ—Ö —Å–∏—Å—Ç–µ–º–Ω–∏—Ö –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3-pip python3-setuptools python3-wheel \
          openjdk-11-jdk zlib1g-dev \
          autoconf automake libtool libltdl-dev m4 \
          pkg-config libffi-dev libssl-dev git unzip wget zip \
          build-essential

    # ‚öôÔ∏è –ö–µ—à Android SDK, NDK —ñ Buildozer
    - name: Cache Android & Buildozer
      uses: actions/cache@v4
      with:
        path: |
          ~/.buildozer
          ~/.local/share/python-for-android
          ~/.android
          /home/runner/.buildozer/android/platform
        key: ${{ runner.os }}-buildozer-${{ hashFiles('buildozer.spec') }}
        restore-keys: |
          ${{ runner.os }}-buildozer-

    # üì¶ –û–Ω–æ–≤–ª–µ–Ω–Ω—è pip —ñ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è Buildozer
    - name: Install Python tools
      run: |
        python3 -m pip install --upgrade pip
        pip install --upgrade Cython virtualenv buildozer

    # üèóÔ∏è –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞
    - name: Prepare environment
      run: |
        mkdir -p ~/.buildozer
        export PATH=$PATH:~/.local/bin
        echo "‚úÖ Environment ready"

    # üöÄ –ó–±—ñ—Ä–∫–∞ APK
    - name: Build APK (debug)
      run: |
        buildozer android debug --verbose
      env:
        USE_SDK_WRAPPER: "1"

    # üì§ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≥–æ—Ç–æ–≤–æ–≥–æ APK —è–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—É
    - name: Upload built APK
      uses: actions/upload-artifact@v4
      with:
        name: XT-ScalperPro-APK
        path: bin/*.apk
